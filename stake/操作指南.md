# 部署指南

## 部署流程

### 1. 环境准备

#### 1.1 安装依赖
```bash
# 智能合约项目
cd stake-contract
npm install

# 前端项目
cd stake-fe
npm install
```

#### 1.2 配置环境变量

**合约项目 (.env)**
```bash
SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/YOUR_PROJECT_ID
PRIVATE_KEY=your_private_key_here
METANODE_TOKEN_ADDRESS=0x...
START_BLOCK=6529999
END_BLOCK=9529999
METANODE_PER_BLOCK=20000000000000000
```

**前端项目 (.env)**
```bash
NEXT_PUBLIC_STAKE_CONTRACT_ADDRESS=0x...
NEXT_PUBLIC_METANODE_TOKEN_ADDRESS=0x...
NEXT_PUBLIC_CHAIN_ID=11155111
```

### 2. 智能合约部署

#### 2.1 编译合约
```bash
cd stake-contract
npx hardhat compile
```

#### 2.2 运行测试
```bash
npx hardhat test
```

#### 2.3 部署到测试网
```bash
npx hardhat run scripts/deploy.js --network sepolia
```

#### 2.4 验证部署
```bash
npx hardhat run scripts/security-check.js --network sepolia
```

### 3. 前端部署

#### 3.1 配置合约地址
更新前端环境变量中的合约地址。

#### 3.2 本地测试
```bash
cd stake-fe
npm run dev
```

#### 3.3 构建生产版本
```bash
npm run build
```

#### 3.4 部署到 Vercel
```bash
npm i -g vercel
vercel --prod
```

## 部署检查清单

### 部署前检查
- [ ] 环境变量配置正确
- [ ] 测试全部通过
- [ ] 合约编译成功
- [ ] 账户余额充足

### 部署后验证
- [ ] 合约地址正确记录
- [ ] 前端能正常连接
- [ ] 质押功能正常
- [ ] 奖励计算正确
- [ ] 解质押功能正常

## 故障排除

### 常见问题

**合约部署失败**
```bash
# 检查网络连接
npx hardhat console --network sepolia

# 检查账户余额
npx hardhat balance --address YOUR_ADDRESS --network sepolia
```

**前端连接问题**
```bash
# 检查网络配置
npx hardhat verify --network sepolia CONTRACT_ADDRESS

# 检查合约交互
npx hardhat run scripts/interact.js --network sepolia
```

### 性能优化建议

1. **Gas 优化**
   - 使用批量操作减少交易次数
   - 优化存储布局
   - 使用视图函数减少 gas 消耗

2. **前端优化**
   - 使用缓存减少 RPC 调用
   - 实现懒加载
   - 优化图片和资源

## 监控和维护

### 监控指标
- 合约交易量
- Gas 消耗
- 用户活跃度
- 奖励分配情况

### 定期维护
- 检查合约状态
- 更新前端依赖
- 备份重要数据
- 安全审计

## 升级流程

### 合约升级
1. 开发新版本合约
2. 编写迁移脚本
3. 测试升级逻辑
4. 执行升级操作
5. 验证升级结果

### 前端升级
1. 更新合约地址
2. 测试新功能
3. 部署新版本
4. 监控用户反馈

## 安全注意事项

1. **私钥安全**
   - 使用环境变量存储私钥
   - 不要提交私钥到版本控制
   - 使用硬件钱包管理主网私钥

2. **合约安全**
   - 进行代码审计
   - 测试边界条件
   - 实现紧急停止机制

3. **前端安全**
   - 验证用户输入
   - 使用 HTTPS
   - 防止 XSS 攻击